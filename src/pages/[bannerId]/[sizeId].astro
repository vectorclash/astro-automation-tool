---
import Logo from '../../components/svg/Logo.astro';
import DefaultContent from '../../components/content/DefaultContent.astro';
import SimpleContent from '../../components/content/SimpleContent.astro';
import bannerData from '../../data/banners.json';
import type { BannerData } from '../../types/banner';
import fs from 'fs';
import path from 'path';

const data = bannerData as BannerData;

// Map of available content templates
const contentTemplates = {
  'DefaultContent': DefaultContent,
  'SimpleContent': SimpleContent,
};

export async function getStaticPaths() {
  const data = bannerData as BannerData;

  return data.banners.flatMap(banner =>
    banner.sizes.map(size => ({
      params: {
        bannerId: banner.id,
        sizeId: `${size.width}x${size.height}`
      },
      props: { banner, size }
    }))
  );
}

const { bannerId, sizeId } = Astro.params;
const { banner, size } = Astro.props;

// Create title string to avoid rendering issues
const pageTitle = `${banner.name} - ${size.width}x${size.height}`;

// Read CSS files and inline them
const resetCssPath = path.join(process.cwd(), 'src/styles/reset.css');
const baseCssPath = path.join(process.cwd(), 'src/styles/banner-base.css');
const sizeCssPath = path.join(process.cwd(), `src/styles/sizes/${size.width}x${size.height}.css`);
const resetCss = fs.readFileSync(resetCssPath, 'utf-8');
const baseCss = fs.readFileSync(baseCssPath, 'utf-8');
const sizeCss = fs.readFileSync(sizeCssPath, 'utf-8');

// Read web font loader and inline it
const webFontLoaderPath = path.join(process.cwd(), 'src/scripts/webfontloader.js');
const webFontLoaderCode = fs.readFileSync(webFontLoaderPath, 'utf-8');

// Read our custom GSAP animation code and inline it
const animationPath = path.join(process.cwd(), 'src/scripts/banner-animation.js');
let animationCode = fs.readFileSync(animationPath, 'utf-8');
// Remove ES6 imports/exports for inline use
animationCode = animationCode.replace(/import\s+{[^}]+}\s+from\s+['"][^'"]+['"];?\s*/g, '');
animationCode = animationCode.replace(/export\s+/g, '');

const sizeClass = `size-${size.width}x${size.height}`;
const bannerElementId = `banner-${banner.id}-${size.width}x${size.height}`;

// Determine logo variant based on banner size
// Use icon for smaller banners, full logo for larger ones
const logoVariant = size.height < 90 ? 'icon' : 'full';

// Get the content template component (defaults to DefaultContent)
const templateName = banner.contentTemplate || 'DefaultContent';
const ContentComponent = contentTemplates[templateName as keyof typeof contentTemplates] || DefaultContent;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="ad.size" content={`width=${size.width},height=${size.height}`} />
    <title>{pageTitle}</title>
    <script is:inline>
      var clickTag = "https://www.att.com/";
    </script>
    <style set:html={resetCss}></style>
    <style set:html={baseCss}></style>
    <style set:html={sizeCss}></style>
  </head>
  <body>
    <div id={bannerElementId} class={`banner ${sizeClass}`} data-banner-id={banner.id} data-size={sizeId}>
      {banner.assets?.embrace && ['300x250', '160x600', '300x600'].includes(sizeId) && (
        <img src={banner.assets.embrace} alt="" class="embrace" />
      )}
      <Logo class="logo" variant={logoVariant} fill="#ffffff" />
      <div class="banner-container">
        <div class="banner-content">
          <ContentComponent banner={banner} size={size} sizeId={sizeId} />
        </div>
      </div>
    </div>

    <!-- Load WebFont Loader first -->
    <script is:inline set:html={webFontLoaderCode}></script>

    <!-- Load GSAP libraries -->
    <script is:inline src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js"></script>
    <script is:inline src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/SplitText.min.js"></script>

    <!-- Load animation code -->
    <script is:inline set:html={animationCode}></script>

    <!-- Unified initialization system -->
    <script is:inline define:vars={{ bannerElementId, width: size.width, height: size.height }}>
      (function() {
        // Track loading state
        const loadingState = {
          dom: false,
          fonts: false
        };

        // Check if everything is ready
        function checkReady() {
          if (loadingState.dom && loadingState.fonts) {
            console.log('All assets ready, initializing banner');
            startBanner();
          }
        }

        // Start banner animation and setup click handler
        function startBanner() {
          // Initialize animation (this will handle image preloading internally)
          initAnimation({
            containerId: bannerElementId,
            width: width,
            height: height
          });

          // Setup click handler
          var banner = document.getElementById(bannerElementId);
          if (banner) {
            banner.style.cursor = 'pointer';
            banner.addEventListener('click', function() {
              if (clickTag) {
                window.open(clickTag, '_blank');
              }
            });
          }
        }

        // Load fonts
        WebFont.load({
          google: {
            families: ['Roboto:300,400,700']
          },
          active: function() {
            console.log('Fonts loaded');
            loadingState.fonts = true;
            checkReady();
          },
          inactive: function() {
            console.log('Fonts failed to load, continuing anyway');
            loadingState.fonts = true;
            checkReady();
          }
        });

        // Wait for DOM
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM ready');
            loadingState.dom = true;
            checkReady();
          });
        } else {
          console.log('DOM ready');
          loadingState.dom = true;
          checkReady();
        }
      })();
    </script>
  </body>
</html>
