---
import type { Banner, BannerSize } from '../../types/banner';

interface Props {
  banner: Banner;
  size: BannerSize;
  isStandalone?: boolean;
}

const { banner, size, isStandalone = false } = Astro.props;
const sizeClass = `size-${size.width}x${size.height}`;
const bannerId = `banner-${banner.id}-${size.id}`;
---

<div
  id={bannerId}
  class={`banner ${sizeClass}`}
  data-banner-id={banner.id}
  data-size-id={size.id}
>
  <a href={banner.clickthrough} target="_blank" rel="noopener noreferrer" class="banner-link">
    {banner.assets.background && (
      <img
        src={banner.assets.background}
        alt=""
        class="banner-background"
      />
    )}

    {banner.assets.logo && (
      <img
        src={banner.assets.logo}
        alt="Logo"
        class="banner-logo"
      />
    )}

    <div class="banner-container">
      <div class="banner-content">
        {(size.id === 'leaderboard' || size.id === 'mobile-banner') ? (
          <>
            <div class="text-group">
              {banner.content.eyebrow && size.id !== 'mobile-banner' && (
                <div class="eyebrow">{banner.content.eyebrow}</div>
              )}
              <div class="headline">{banner.content.headline}</div>
              {size.id !== 'mobile-banner' && (
                <div class="subhead">{banner.content.subhead}</div>
              )}
            </div>
            <div class="cta-button">{banner.content.cta}</div>
          </>
        ) : (
          <>
            {banner.content.eyebrow && (
              <div class="eyebrow">{banner.content.eyebrow}</div>
            )}
            <div class="headline">{banner.content.headline}</div>
            <div class="subhead">{banner.content.subhead}</div>
            <div class="cta-button">{banner.content.cta}</div>
          </>
        )}
      </div>
    </div>
  </a>
</div>

{isStandalone && (
  <>
    <link rel="stylesheet" href="/styles/banner-base.css" />
    <link rel="stylesheet" href={`/styles/sizes/${size.width}x${size.height}.css`} />
  </>
)}

<script define:vars={{ banner, size, bannerId }}>
  function initBannerAnimation(containerId, config) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const animationTimeouts = [];

    function reset() {
      config.animation.timeline.forEach((step) => {
        const element = container.querySelector(`.${step.element}`);
        if (element) {
          element.style.opacity = '0';
          element.className = element.className.replace(/\s?(fade-in|fade-in-up|fade-in-down|slide-in-left|slide-in-right|scale)/g, '');
        }
      });
    }

    function getAnimationClass(effect) {
      const effectMap = {
        'fadeIn': 'fade-in',
        'fadeInUp': 'fade-in-up',
        'fadeInDown': 'fade-in-down',
        'slideInLeft': 'slide-in-left',
        'slideInRight': 'slide-in-right',
        'scale': 'scale'
      };
      return effectMap[effect] || 'fade-in';
    }

    function animateElement(step) {
      const element = container.querySelector(`.${step.element}`);
      if (!element) return;

      element.className = element.className.replace(/\s?(fade-in|fade-in-up|fade-in-down|slide-in-left|slide-in-right|scale)/g, '');
      const animationClass = getAnimationClass(step.effect);
      element.classList.add(animationClass);
      element.style.animationDuration = `${step.duration}ms`;
    }

    function playTimeline() {
      config.animation.timeline.forEach((step) => {
        const timeout = setTimeout(() => {
          animateElement(step);
        }, step.delay);
        animationTimeouts.push(timeout);
      });
    }

    function start() {
      reset();
      playTimeline();

      if (config.animation.loop) {
        const timeout = setTimeout(() => {
          start();
        }, config.animation.duration);
        animationTimeouts.push(timeout);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => start());
    } else {
      start();
    }
  }

  const config = {
    animation: banner.animation,
    sizeId: size.id,
    width: size.width,
    height: size.height
  };

  initBannerAnimation(bannerId, config);
</script>

<style>
  .banner-link {
    display: block;
    width: 100%;
    height: 100%;
    text-decoration: none;
  }
</style>
